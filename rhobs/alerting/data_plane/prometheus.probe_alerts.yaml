apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: rhtap-probe-alerting
  labels:
    tenant: rhtap
spec:
  groups:
    - name: probe_alerts
      interval: 1m
      rules:

      - alert: ProbeAlert
        expr: |
          konflux_up{
          check="probe",
          service!~".*-vpn|.*static-host|.*pwvs"
          } != 1
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: >-
             Probe alert {{ $labels.job }}.
          description: >-
             Probe alert instance {{ $labels.instance }} with job {{ $labels.job }} and target {{ $labels.target }} for cluster {{ $labels.source_cluster }}.
          alert_team_handle: '<!subteam^S06V06A36F5> <!subteam^S05Q1P4Q2TG>'
          runbook_url: https://gitlab.cee.redhat.com/konflux/docs/sop/-/blob/main/o11y/blackbox/probe-alerts.md
          slo: "true"

      - alert: S390xStaticHostProbeAlert
        expr: |
          konflux_up{
          check="probe-s390x",
          service=~".*-static-host"
          } != 1
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: >-
             Infra S390x Static Host Probe alert {{ $labels.job }}.
          description: >-
             Probe alert with job {{ $labels.job }} for cluster {{ $labels.source_cluster }}.
          alert_team_handle: '<!subteam^S06V06A36F5> <!subteam^S05Q1P4Q2TG>'
          runbook_url: https://gitlab.cee.redhat.com/konflux/docs/sop/-/blob/main/infra/sre/static_host_probe_alerts.md
          slo: "true"

      - alert: PPCStaticHostProbeAlert
        expr: |
          konflux_up{
          check="probe-ppc",
          service=~".*-static-host"
          } != 1
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: >-
             Infra PPC Static Host Probe alert {{ $labels.job }}.
          description: >-
             Probe alert with job {{ $labels.job }} for cluster {{ $labels.source_cluster }}.
          alert_team_handle: '<!subteam^S06V06A36F5> <!subteam^S05Q1P4Q2TG>'
          runbook_url: https://gitlab.cee.redhat.com/konflux/docs/sop/-/blob/main/infra/sre/static_host_probe_alerts.md
          slo: "true"

      - alert: VPNProbeAlert
        expr: |
          konflux_up{
          check="probe-vpn",
          service=~".*vpn"
          } != 1
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: >-
             VPN Probe alert {{ $labels.job }}.
          description: >-
             Probe alert with job {{ $labels.job }} and target {{ $labels.target }} for cluster {{ $labels.source_cluster }}.
          alert_team_handle: '<!subteam^S06V06A36F5> <!subteam^S05Q1P4Q2TG>'
          runbook_url: https://gitlab.cee.redhat.com/konflux/docs/sop/-/blob/main/infra/sre/vpn_probe_alerts.md
          slo: "true"

      - alert: PWVSProbeAlert
        expr: |
          konflux_up{
          check="probe-pwvs",
          service=~".*pwvs"
          } != 1
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: >-
             PWVS Probe alert {{ $labels.job }}.
          description: >-
             Probe alert with job {{ $labels.job }} and target {{ $labels.target }} for cluster {{ $labels.source_cluster }}.
          alert_team_handle: '<!subteam^S06V06A36F5> <!subteam^S05Q1P4Q2TG>'
          runbook_url: https://gitlab.cee.redhat.com/konflux/docs/sop/-/blob/main/infra/sre/vpn_probe_alerts.md
          slo: "true"
