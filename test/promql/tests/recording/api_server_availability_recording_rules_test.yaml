evaluation_interval: 1m

rule_files:
  - api_server_availability_recording_rules.yaml

tests:
  # Start of a new test case. The interval and input series must be under this item.
  - name: Test KonfluxAPIServerHighErrorRate
    interval: 1m
    input_series:
      - series: 'code:apiserver_request_total:rate5m{code="503"}'
        values: '0+5x60'
      - series: 'code:apiserver_request_total:rate5m{code="200"}'
        values: '0+95x60'

    promql_expr_test:
      - expr: konflux_up
        eval_time: 1m
        exp_samples:
          - labels: '{__name__="konflux_up", service="api-server"}'
            value: 1

  - name: Test api_server_error_rate_5m with only 5xx errors
    interval: 1m
    input_series:
      - series: 'code:apiserver_request_total:rate5m{code="503", source_cluster="cluster-a"}'
        values: '10+0x60'
      - series: 'code:apiserver_request_total:rate5m{code="500", source_cluster="cluster-a"}'
        values: '5+0x60'

    promql_expr_test:
      - expr: api_server_error_rate_5m
        eval_time: 5m
        exp_samples:
          - labels: '{__name__="api_server_error_rate_5m", source_cluster="cluster-a"}'
            value: 15

  - name: Test api_server_error_rate_5m with only 4xx errors
    interval: 1m
    input_series:
      - series: 'code:apiserver_request_total:rate5m{code="404", source_cluster="cluster-b"}'
        values: '8+0x60'
      - series: 'code:apiserver_request_total:rate5m{code="429", source_cluster="cluster-b"}'
        values: '2+0x60'

    promql_expr_test:
      - expr: api_server_error_rate_5m
        eval_time: 5m
        exp_samples:
          - labels: '{__name__="api_server_error_rate_5m", source_cluster="cluster-b"}'
            value: 10

  - name: Test api_server_error_rate_5m with both 4xx and 5xx errors
    interval: 1m
    input_series:
      - series: 'code:apiserver_request_total:rate5m{code="503", source_cluster="cluster-c"}'
        values: '12+0x60'
      - series: 'code:apiserver_request_total:rate5m{code="404", source_cluster="cluster-c"}'
        values: '8+0x60'

    promql_expr_test:
      - expr: api_server_error_rate_5m
        eval_time: 5m
        exp_samples:
          - labels: '{__name__="api_server_error_rate_5m", source_cluster="cluster-c"}'
            value: 20

  - name: Test api_server_error_rate_5m with multiple source_clusters
    interval: 1m
    input_series:
      - series: 'code:apiserver_request_total:rate5m{code="503", source_cluster="cluster-x"}'
        values: '5+0x60'
      - series: 'code:apiserver_request_total:rate5m{code="404", source_cluster="cluster-x"}'
        values: '3+0x60'
      - series: 'code:apiserver_request_total:rate5m{code="500", source_cluster="cluster-y"}'
        values: '7+0x60'
      - series: 'code:apiserver_request_total:rate5m{code="429", source_cluster="cluster-y"}'
        values: '2+0x60'

    promql_expr_test:
      - expr: api_server_error_rate_5m
        eval_time: 5m
        exp_samples:
          - labels: '{__name__="api_server_error_rate_5m", source_cluster="cluster-x"}'
            value: 8
          - labels: '{__name__="api_server_error_rate_5m", source_cluster="cluster-y"}'
            value: 9

  - name: Test api_server_error_rate_5m with no errors (no output expected)
    interval: 1m
    input_series:
      - series: 'code:apiserver_request_total:rate5m{code="200", source_cluster="cluster-d"}'
        values: '100+100x60'
      - series: 'code:apiserver_request_total:rate5m{code="201", source_cluster="cluster-d"}'
        values: '50+50x60'

    promql_expr_test:
      - expr: api_server_error_rate_5m
        eval_time: 5m
        exp_samples: []
