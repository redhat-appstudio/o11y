evaluation_interval: 1m

rule_files:
  - api_server_availability_recording_rules.yaml

tests:
  # Start of a new test case. The interval and input series must be under this item.
  - name: Test KonfluxAPIServerHighErrorRate
    interval: 1m # Correct placement and spelling of interval
    input_series:
      - series: 'code:apiserver_request_total:rate5m{code="503"}'
        values: '0+5x60'
      - series: 'code:apiserver_request_total:rate5m{code="200"}'
        values: '0+95x60'

    promql_expr_test:
      - expr: konflux_up
        eval_time: 1m
        exp_samples:
          - labels: '{__name__="konflux_up", service="api-server"}'
            value: 1

  - name: Test api_server_error_rate_5m at 5 percent (5xx errors)
    interval: 1m
    input_series:
      - series: 'code:apiserver_request_total:rate5m{code="503", source_cluster="test-cluster"}'
        values: '0+5x60'
      - series: 'code:apiserver_request_total:rate5m{code="200", source_cluster="test-cluster"}'
        values: '0+95x60'

    promql_expr_test:
      - expr: api_server_error_rate_5m
        eval_time: 5m
        exp_samples:
          - labels: '{__name__="api_server_error_rate_5m", service="api-server"}'
            value: 0.000001
          - labels: '{__name__="api_server_error_rate_5m", service="api-server", source_cluster="test-cluster"}'
            value: 0.05

  - name: Test api_server_error_rate_5m at 20 percent (4xx + 5xx errors)
    interval: 1m
    input_series:
      - series: 'code:apiserver_request_total:rate5m{code="503", source_cluster="test-cluster-mixed"}'
        values: '10+10x60'
      - series: 'code:apiserver_request_total:rate5m{code="404", source_cluster="test-cluster-mixed"}'
        values: '10+10x60'
      - series: 'code:apiserver_request_total:rate5m{code="200", source_cluster="test-cluster-mixed"}'
        values: '80+80x60'

    promql_expr_test:
      - expr: api_server_error_rate_5m
        eval_time: 5m
        exp_samples:
          - labels: '{__name__="api_server_error_rate_5m", service="api-server"}'
            value: 0.000001
          - labels: '{__name__="api_server_error_rate_5m", service="api-server", source_cluster="test-cluster-mixed"}'
            value: 0.2
