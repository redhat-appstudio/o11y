evaluation_interval: 1m

rule_files:
  - pulp_controller_availability_recording_rules.yaml

tests:
  - name: PulpControllerAvailabilityAllUpTest
    interval: 1m
    input_series:
      - series: "kube_deployment_status_replicas_available{namespace='pulp-access-controller', deployment='pulp-access-operator'}"
        values: "3 3 3 3 3"
      - series: "kube_deployment_spec_replicas{namespace='pulp-access-controller', deployment='pulp-access-operator'}"
        values: "3 3 3 3 3"

    promql_expr_test:
      - expr: konflux_up
        eval_time: 5m
        exp_samples:
          - labels: konflux_up{service='pulp-access-operator', check='replicas-available', namespace='pulp-access-controller', deployment='pulp-access-operator'}
            value: 1

  - name: PulpControllerAvailabilitySomeUpTest
    interval: 1m
    input_series:
      - series: "kube_deployment_status_replicas_available{namespace='pulp-access-controller', deployment='pulp-access-operator'}"
        values: "2 2 2 2 2"
      - series: "kube_deployment_spec_replicas{namespace='pulp-access-controller', deployment='pulp-access-operator'}"
        values: "4 4 4 4 4"

    promql_expr_test:
      - expr: konflux_up
        eval_time: 5m
        exp_samples:
          - labels: konflux_up{service='pulp-access-operator', check='replicas-available', namespace='pulp-access-controller', deployment='pulp-access-operator'}
            value: 0

  - name: PulpControllerAvailabilityMultipleDeploymentsTest
    interval: 1m
    input_series:
      # should be up (c1)
      - series: "kube_deployment_status_replicas_available{namespace='pulp-access-controller', deployment='pulp-access-operator', source_cluster='c1'}"
        values: "1 1 1 1 1"
      - series: "kube_deployment_spec_replicas{namespace='pulp-access-controller', deployment='pulp-access-operator', source_cluster='c1'}"
        values: "1 1 1 1 1"

      # should be down (c2)
      - series: "kube_deployment_status_replicas_available{namespace='pulp-access-controller', deployment='pulp-access-operator', source_cluster='c2'}"
        values: "0 0 0 0 0"
      - series: "kube_deployment_spec_replicas{namespace='pulp-access-controller', deployment='pulp-access-operator', source_cluster='c2'}"
        values: "1 1 1 1 1"

      # should be up (another deployment from c1)
      - series: "kube_deployment_status_replicas_available{namespace='pulp-access-controller', deployment='pulp-access-operator2', source_cluster='c1'}"
        values: "2 2 2 2 2"
      - series: "kube_deployment_spec_replicas{namespace='pulp-access-controller', deployment='pulp-access-operator2', source_cluster='c1'}"
        values: "1 1 1 1 1"
    promql_expr_test:
      - expr: konflux_up
        eval_time: 5m
        exp_samples:
          - labels: konflux_up{service='pulp-access-operator', check='replicas-available', namespace='pulp-access-controller', deployment='pulp-access-operator', source_cluster='c1'}
            value: 1
          - labels: konflux_up{service='pulp-access-operator', check='replicas-available', namespace='pulp-access-controller', deployment='pulp-access-operator', source_cluster='c2'}
            value: 0
          - labels: konflux_up{service='pulp-access-operator2', check='replicas-available', namespace='pulp-access-controller', deployment='pulp-access-operator2', source_cluster='c1'}
            value: 1

  - name: ImageControllerAbsent
    interval: 1m
    input_series:
      - series: "kube_deployment_status_replicas_available{namespace='another-controller', deployment='d1'}"
        values: "1 1 1 1 1"
      - series: "kube_deployment_spec_replicas{namespace='another-controller', deployment='d1'}"
        values: "1 1 1 1 1"

    promql_expr_test:
      - expr: konflux_up
        eval_time: 5m
        exp_samples: []
