evaluation_interval: 5m

rule_files:
  - api_server_monitoring_recording_rules.yaml

tests:
  # Test 30 days average calculation
  - name: Test resource_apiserver_storage_objects_avg_30d
    interval: 5m
    input_series:
      - series: 'apiserver_storage_objects{resource="pods", source_cluster="cluster01"}'
        values: '100+10x8'
      - series: 'apiserver_storage_objects{resource="deployments", source_cluster="cluster01"}'
        values: '50+5x8'
      - series: 'apiserver_storage_objects{resource="pods", source_cluster="cluster02"}'
        values: '200+20x8'

    promql_expr_test:
      - expr: resource_apiserver_storage_objects_avg_30d
        eval_time: 40m
        exp_samples:
          - labels: 'resource_apiserver_storage_objects_avg_30d{resource="pods", source_cluster="cluster01"}'
            value: 140
          - labels: 'resource_apiserver_storage_objects_avg_30d{resource="deployments", source_cluster="cluster01"}'
            value: 70
          - labels: 'resource_apiserver_storage_objects_avg_30d{resource="pods", source_cluster="cluster02"}'
            value: 280

  # Test 12 hours average calculation
  - name: Test resource_apiserver_storage_objects_avg_12h
    interval: 5m
    input_series:
      - series: 'apiserver_storage_objects{resource="services", source_cluster="cluster01"}'
        values: '80+0x8'
      - series: 'apiserver_storage_objects{resource="configmaps", source_cluster="cluster01"}'
        values: '40+10x8'

    promql_expr_test:
      - expr: resource_apiserver_storage_objects_avg_12h
        eval_time: 40m
        exp_samples:
          - labels: 'resource_apiserver_storage_objects_avg_12h{resource="services", source_cluster="cluster01"}'
            value: 80
          - labels: 'resource_apiserver_storage_objects_avg_12h{resource="configmaps", source_cluster="cluster01"}'
            value: 80

  # Test 30 days standard deviation calculation
  - name: Test resource_apiserver_storage_objects_std_30d
    interval: 5m
    input_series:
      - series: 'apiserver_storage_objects{resource="services", source_cluster="cluster01"}'
        values: '100 100 100 100 100 100 100 100 100'
      - series: 'apiserver_storage_objects{resource="namespaces", source_cluster="cluster01"}'
        values: '10 20 30 40 50 60 70 80 90'

    promql_expr_test:
      - expr: resource_apiserver_storage_objects_std_30d
        eval_time: 40m
        exp_samples:
          - labels: 'resource_apiserver_storage_objects_std_30d{resource="services", source_cluster="cluster01"}'
            value: 0
          - labels: 'resource_apiserver_storage_objects_std_30d{resource="namespaces", source_cluster="cluster01"}'
            value: 25.81988897471611
