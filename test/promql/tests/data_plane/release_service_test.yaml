rule_files:
  - prometheus.release_service_alerts.yaml

evaluation_interval: 1m

tests:
  - name: ReleaseServiceAlertOnPreProcessingSLOFailure
    interval: 1m
    input_series:
      - series: 'release_pre_processing_duration_seconds_bucket{le="60", job="release", namespace="foo", source_cluster="cluster01"}'
        values: '1+8x59'
      - series: 'release_pre_processing_duration_seconds_count{job="release", namespace="foo", source_cluster="cluster01"}'
        values: '1+9x59'
      - series: 'release_pre_processing_duration_seconds_bucket{le="60", job="release", namespace="foo", source_cluster="cluster01"}'
        values: '1+8x59'
      - series: 'release_pre_processing_duration_seconds_count{job="release", namespace="foo", source_cluster="cluster01"}'
        values: '1+9x59'
    alert_rule_test:
      - eval_time: 1h
        alertname: ReleaseServicePreProcessingDurationSeconds
        exp_alerts:
          - exp_labels:
              severity: high
              slo: "false"
              job: "release"
              source_cluster: "cluster01"
            exp_annotations:
              summary: >-
                90% of Releases must start processing under 10 seconds
              description: >-
                Release service is failing to start processing under 10 seconds for 90% of releases
              alert_routing_key: release-service
              runbook_url: https://gitlab.cee.redhat.com/konflux/docs/sop/-/blob/main/release-service/release-processing-latency.md?ref_type=heads
              team: release

  - name: ReleaseServiceAlertOnValidationSLOFailure
    interval: 1m
    input_series:
      - series: 'release_validation_duration_seconds_bucket{le="5", job="release", namespace="foo", source_cluster="cluster01"}'
        values: '1+8x59'
      - series: 'release_validation_duration_seconds_count{job="release", namespace="foo", source_cluster="cluster01"}'
        values: '1+9x59'
      - series: 'release_validation_duration_seconds_bucket{le="5", job="release", namespace="foo", source_cluster="cluster01"}'
        values: '1+8x59'
      - series: 'release_validation_duration_seconds_count{job="release", namespace="foo", source_cluster="cluster01"}'
        values: '1+9x59'
    alert_rule_test:
      - eval_time: 1h
        alertname: ReleaseServiceValidationDurationSeconds
        exp_alerts:
          - exp_labels:
              severity: critical
              slo: "true"
              job: "release"
              source_cluster: "cluster01"
            exp_annotations:
              summary: >-
                90% of Releases must be validated under 5 seconds
              description: >-
                Release service is failing to run the validations under 5 seconds for 90% of releases
              alert_team_handle: <!subteam^S03SVBS426R>
              runbook_url: https://gitlab.cee.redhat.com/konflux/docs/sop/-/blob/main/release-service/release-validation-latency.md?ref_type=heads
              team: release

  - name: ReleaseServiceControllerManagerOnPodNotReadyStonePrdRh01
    interval: 1m
    input_series:
      - series: 'kube_pod_container_status_ready{namespace="release-service", container="manager", source_cluster="stone-prd-rh01"}'
        values: '1 0x58'
      - series: 'kube_pod_container_status_ready{namespace="release-service", container="manager", source_cluster="stone-prod-p02"}'
        values: '1 1x58'
    alert_rule_test:
      - eval_time: 1h
        alertname: ReleaseServiceControllerManagerPodNotReady
        exp_alerts:
          - exp_labels:
              severity: high
              source_cluster: "stone-prd-rh01"
              namespace: "release-service"
            exp_annotations:
              summary: The Release Service Controller Manager is down in the stone-prd-rh01 for the last 10 minutes
              description: >-
                The Release Service Controller Manager is down in the stone-prd-rh01 for the last 10 minutes
              alert_routing_key: "release-service"
              runbook_url: https://gitlab.cee.redhat.com/konflux/docs/sop/-/blob/main/release-service/release-controller-availability.md?ref_type=heads
              team: release

  - name: ReleaseServiceControllerManagerOnPodNotReadyStoneProdP02
    interval: 1m
    input_series:
      - series: 'kube_pod_container_status_ready{namespace="release-service", container="manager", source_cluster="stone-prd-rh01"}'
        values: '1 1x58'
      - series: 'kube_pod_container_status_ready{namespace="release-service", container="manager", source_cluster="stone-prod-p02"}'
        values: '1 0x58'
    alert_rule_test:
      - eval_time: 1h
        alertname: ReleaseServiceControllerManagerPodNotReady
        exp_alerts:
          - exp_labels:
              severity: high
              source_cluster: "stone-prod-p02"
              namespace: "release-service"
            exp_annotations:
              summary: The Release Service Controller Manager is down in the stone-prod-p02 for the last 10 minutes
              description: >-
                The Release Service Controller Manager is down in the stone-prod-p02 for the last 10 minutes
              alert_routing_key: "release-service"
              runbook_url: https://gitlab.cee.redhat.com/konflux/docs/sop/-/blob/main/release-service/release-controller-availability.md?ref_type=heads
              team: release

  - name: ReleaseServiceControllerManagerOnPodReady
    interval: 1m
    input_series:
      - series: 'kube_pod_container_status_ready{namespace="release-service", container="manager", source_cluster="stone-prd-rh01"}'
        values: '1 1x58'
      - series: 'kube_pod_container_status_ready{namespace="release-service", container="manager", source_cluster="stone-prod-p02"}'
        values: '1 1x58'
    alert_rule_test:
      - eval_time: 1h
        alertname: ReleaseServiceControllerManagerPodNotReady
        exp_alerts: []

  - name: ReleaseServiceControllerManagerDown
    interval: 1m
    input_series:
      - series: 'konflux_up{namespace="release-service", check="replicas-available", service="release-service-controller-manager", deployment="release-service-controller-manager", source_cluster="c1"}'
        values: '0+0x20'
    alert_rule_test:
      - eval_time: 10m
        alertname: ReleaseServiceControllerManagerDown
        exp_alerts:
          - exp_labels:
              severity: critical
              namespace: release-service
              check: replicas-available
              service: release-service-controller-manager
              deployment: release-service-controller-manager
              slo: "true"
              source_cluster: c1
            exp_annotations:
              summary: Release Service Controller Manager pod is down in cluster c1
              description: >
                Release Service Controller Manager pod has been down for 10 minutes in cluster c1
              alert_routing_key: "release-service"
              runbook_url: https://gitlab.cee.redhat.com/konflux/docs/sop/-/blob/main/release-service/release-controller-availability.md?ref_type=heads
              team: release
