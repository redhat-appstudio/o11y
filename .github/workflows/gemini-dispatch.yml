name: 'ðŸ”€ Gemini Dispatch'

on:
  pull_request_review_comment:
    types:
      - 'created'
  pull_request_review:
    types:
      - 'submitted'
  pull_request_target:
    types:
      - 'opened'
  issues:
    types:
      - 'opened'
      - 'reopened'
  issue_comment:
    types:
      - 'created'

defaults:
  run:
    shell: 'bash'

jobs:
  # debugger:
  #   if: |-
  #     ${{ fromJSON(vars.GEMINI_DEBUG || vars.ACTIONS_STEP_DEBUG || false) }}
  #   runs-on: 'ubuntu-latest'
  #   permissions:
  #     contents: 'read'
  #   steps:
  #     - name: 'Print context for debugging'
  #       env:
  #         DEBUG_event_name: '${{ github.event_name }}'
  #         DEBUG_event__action: '${{ github.event.action }}'
  #         DEBUG_event__comment__author_association: '${{ github.event.comment.author_association }}'
  #         DEBUG_event__issue__author_association: '${{ github.event.issue.author_association }}'
  #         DEBUG_event__pull_request__author_association: '${{ github.event.pull_request.author_association }}'
  #         DEBUG_event__review__author_association: '${{ github.event.review.author_association }}'
  #         DEBUG_event: '${{ toJSON(github.event) }}'
  #       run: |-
  #         env | grep '^DEBUG_'

  dispatch:
    # Trigger conditions:
    # 1. For new PRs (including forks): always run auto-review
    # 2. For issues: only on open/reopen
    # 3. For @gemini-cli commands: only if user is org MEMBER, CONTRIBUTOR, or COLLABORATOR
    #    (CONTRIBUTOR = anyone who has previously contributed to the repo)
    # Note: Using pull_request_target to support fork PRs (runs in base repo context)
    if: |-
      (
        github.event_name == 'pull_request_target'
      ) || (
        github.event_name == 'issues' &&
        contains(fromJSON('["opened", "reopened"]'), github.event.action)
      ) || (
        github.event.sender.type == 'User' &&
        startsWith(github.event.comment.body || github.event.review.body || github.event.issue.body, '@gemini-cli') &&
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR", "CONTRIBUTOR"]'), github.event.comment.author_association || github.event.review.author_association || github.event.issue.author_association)
      )
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
      issues: 'write'
      pull-requests: 'write'
    outputs:
      command: '${{ steps.extract_command.outputs.command }}'
      request: '${{ steps.extract_command.outputs.request }}'
      additional_context: '${{ steps.extract_command.outputs.additional_context }}'
      issue_number: '${{ github.event.pull_request.number || github.event.issue.number }}'
    steps:
      - name: 'Mint identity token'
        id: 'mint_identity_token'
        if: |-
          ${{ vars.APP_ID }}
        uses: 'actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf' # ratchet:actions/create-github-app-token@v2
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'
          permission-contents: 'read'
          permission-issues: 'write'
          permission-pull-requests: 'write'

      - name: 'Extract command'
        id: 'extract_command'
        uses: 'actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea' # ratchet:actions/github-script@v7
        env:
          EVENT_TYPE: '${{ github.event_name }}.${{ github.event.action }}'
          REQUEST: '${{ github.event.comment.body || github.event.review.body || github.event.issue.body }}'
        with:
          script: |
            const request = process.env.REQUEST;
            const eventType = process.env.EVENT_TYPE;
            core.setOutput('request', request);

            // Prioritize explicit @gemini-cli commands over event-type detection
            if (request && request.startsWith("@gemini-cli /review")) {
              core.setOutput('command', 'review');
              const additionalContext = request.replace(/^@gemini-cli \/review/, '').trim();
              core.setOutput('additional_context', additionalContext);
            } else if (request && request.startsWith("@gemini-cli /triage")) {
              core.setOutput('command', 'triage');
            } else if (request && request.startsWith("@gemini-cli")) {
              core.setOutput('command', 'invoke');
              const additionalContext = request.replace(/^@gemini-cli/, '').trim();
              core.setOutput('additional_context', additionalContext);
            } else if (eventType === 'pull_request_target.opened') {
              core.setOutput('command', 'review');
            } else if (['issues.opened', 'issues.reopened'].includes(eventType)) {
              core.setOutput('command', 'triage');
            } else {
              core.setOutput('command', 'fallthrough');
            }

      - name: 'Add Gemini helper comment'
        if: '${{ github.event_name }}.${{ github.event.action }} == "pull_request_target.opened"'
        env:
          GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}'
          PR_NUMBER: '${{ github.event.pull_request.number }}'
          REPOSITORY: '${{ github.repository }}'
          MESSAGE: |-
            ## ðŸ¤– Gemini AI Assistant

            Hi @${{ github.actor }}! I'm here to help with your pull request. You can interact with me using the following commands:

            ### Available Commands

            - **`@gemini-cli /review`** - Request a comprehensive code review
              - Example: `@gemini-cli /review Please focus on PromQL correctness`

            - **`@gemini-cli <your question>`** - Ask me anything about the codebase
              - Example: `@gemini-cli How can I improve this alert rule?`
              - Example: `@gemini-cli What are the best practices for recording rules?`

            ### How to Use

            1. Simply type one of the commands above in a comment on this PR
            2. I'll analyze your code and provide detailed feedback
            3. You can track my progress in the [workflow logs](https://github.com/${{ github.repository }}/actions)

            ### Permissions

            Organization members and past contributors can trigger my responses. This ensures secure and appropriate usage.

            ---

            *This message was automatically added to help you get started with the Gemini AI assistant. Feel free to delete this comment if you don't need assistance.*
        run: |-
          gh pr comment "${PR_NUMBER}" \
            --body "${MESSAGE}" \
            --repo "${REPOSITORY}"

      - name: 'Acknowledge request'
        env:
          GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}'
          ISSUE_NUMBER: '${{ github.event.pull_request.number || github.event.issue.number }}'
          MESSAGE: |-
            ðŸ¤– Hi @${{ github.actor }}, I've received your request, and I'm working on it now! You can track my progress [in the logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
          REPOSITORY: '${{ github.repository }}'
        run: |-
          gh issue comment "${ISSUE_NUMBER}" \
            --body "${MESSAGE}" \
            --repo "${REPOSITORY}"

  review:
    needs: 'dispatch'
    if: |-
      ${{ needs.dispatch.outputs.command == 'review' }}
    uses: './.github/workflows/gemini-review.yml'
    permissions:
      contents: 'read'
      id-token: 'write'
      issues: 'write'
      pull-requests: 'write'
    with:
      additional_context: '${{ needs.dispatch.outputs.additional_context }}'
    secrets: 'inherit'

  # triage:
  #   needs: 'dispatch'
  #   if: |-
  #     ${{ needs.dispatch.outputs.command == 'triage' }}
  #   uses: './.github/workflows/gemini-triage.yml'
  #   permissions:
  #     contents: 'read'
  #     id-token: 'write'
  #     issues: 'write'
  #     pull-requests: 'write'
  #   with:
  #     additional_context: '${{ needs.dispatch.outputs.additional_context }}'
  #   secrets: 'inherit'

  # invoke:
  #   needs: 'dispatch'
  #   if: |-
  #     ${{ needs.dispatch.outputs.command == 'invoke' }}
  #   uses: './.github/workflows/gemini-invoke.yml'
  #   permissions:
  #     contents: 'read'
  #     id-token: 'write'
  #     issues: 'write'
  #     pull-requests: 'write'
  #   with:
  #     additional_context: '${{ needs.dispatch.outputs.additional_context }}'
  #   secrets: 'inherit'

  # fallthrough:
  #   needs:
  #     - 'dispatch'
  #     - 'review'
  #     - 'triage'
  #     - 'invoke'
  #   if: |-
  #     ${{ always() && !cancelled() && (failure() || needs.dispatch.outputs.command == 'fallthrough') }}
  #   runs-on: 'ubuntu-latest'
  #   permissions:
  #     contents: 'read'
  #     issues: 'write'
  #     pull-requests: 'write'
  #   steps:
  #     - name: 'Mint identity token'
  #       id: 'mint_identity_token'
  #       if: |-
  #         ${{ vars.APP_ID }}
  #       uses: 'actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf' # ratchet:actions/create-github-app-token@v2
  #       with:
  #         app-id: '${{ vars.APP_ID }}'
  #         private-key: '${{ secrets.APP_PRIVATE_KEY }}'
  #         permission-contents: 'read'
  #         permission-issues: 'write'
  #         permission-pull-requests: 'write'

  #     - name: 'Send failure comment'
  #       env:
  #         GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}'
  #         ISSUE_NUMBER: '${{ github.event.pull_request.number || github.event.issue.number }}'
  #         MESSAGE: |-
  #           ðŸ¤– I'm sorry @${{ github.actor }}, but I was unable to process your request. Please [see the logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
  #         REPOSITORY: '${{ github.repository }}'
  #       run: |-
  #         gh issue comment "${ISSUE_NUMBER}" \
  #           --body "${MESSAGE}" \
  #           --repo "${REPOSITORY}"
